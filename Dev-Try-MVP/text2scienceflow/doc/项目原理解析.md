## MathModelAgent

**整体结构**

- 前端（Vue）负责提交题目、展示进度、展示结果与下载文件。
- 后端（FastAPI）负责任务编排、调用多 Agent、执行代码、写作与产出文件。
- Redis 负责任务状态与消息流转（WebSocket 订阅）。

**运行主流程（端到端）**

1. 用户在前端提交题目与数据文件。
2. 前端调用后端 /modeling 接口创建任务，后端生成 task_id 并保存文件到 backend/project/work_dir/{task_id}。代码入口：[modeling_router.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. 后端把任务放入后台执行，开始异步运行 MathModelWorkFlow。代码入口：[workflow.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. 前端通过 WebSocket 连接 /task/{task_id}，后端订阅 Redis 频道 task:{task_id}:messages，持续把执行状态与中间消息推送给前端。代码入口：[ws_router.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[redis_manager.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
5. 工作流执行完成后保存结果，并把 [res.md](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 转换为 docx。

**核心工作流（MathModelWorkFlow）**
文件：[workflow.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

流程如下：

1. **CoordinatorAgent** 解析题面并拆分子问题（输出 ques1...quesN、背景等结构化 JSON）。
   代码：[coordinator_agent.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

2. **ModelerAgent** 根据拆分结果生成每个问题的建模方案。
   代码：[modeler_agent.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

3. 创建工作目录与代码解释器

   - 解释器自动选择本地或远程（E2B），逻辑在 [interpreter_factory.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
   - 运行中间代码会写入 notebook：[notebook_serializer.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

4. CoderAgent

   逐个子任务执行代码（EDA、问题求解、敏感性分析）。

   - 通过工具调用 execute_code 运行 Python。
   - 错误会触发反思重试。
     代码：[coder_agent.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

5. **WriterAgent** 将代码结果与图表整理成论文各部分内容，并可调用 OpenAlex 搜文献。
   代码：[writer_agent.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[openalex_scholar.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

6. 结果被汇总进 UserOutput，写出 [res.md](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，并转换为 docx。
   代码：[user_output.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[common_utils.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

**消息与可视化原理**

- 所有进度与结果通过 Redis 发布（publish_message），WebSocket 订阅并推送给前端。
  代码：[redis_manager.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[ws_router.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
- 代码执行输出通过 BaseCodeInterpreter._push_to_websocket 推送到前端的 Notebook 区域。
  代码：[base_interpreter.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
- 前端通过 TaskWebSocket 连接 WebSocket，更新 UI。
  代码：[websocket.ts](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[task.ts](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

**输出位置**

- 运行产物目录：backend/project/work_dir/{task_id}
  包括 [notebook.ipynb](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[res.md](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、生成的图片等。
  README 已注明：[README.md](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)

**关键配置与模板**

- LLM 模型与 API Key 由后端设置（支持多模型）。
  代码：[llm_factory.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[setting.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
- 写作模板可配置：[md_template.toml](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)



------

**2) [run_paper2technical.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)（paper2technical）**
脚本入口见 [run_paper2technical.py (line 25)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[run_paper2technical.py (line 47)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，对应图在 [wf_paper2technical.py (line 52)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
执行链路：

1. _start_ 初始化输出目录 outputs/paper2tec/<ts>，见 [wf_paper2technical.py (line 375)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
2. 路由分流：
   input_type=="PDF" -> paper_idea_extractor，input_type=="TEXT" -> 直接 technical_route_desc_generator，见 [wf_paper2technical.py (line 354)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. technical_route_desc_generator 生成技术路线 SVG，并渲染成 PNG，见 [wf_paper2technical.py (line 179)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[wf_paper2technical.py (line 218)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. technical_ppt_generator 把路线图（主要用 PNG）插入 PPT，生成 [technical_route_.pptx](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，见 [wf_paper2technical.py (line 243)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[wf_paper2technical.py (line 265)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

核心原理：
这是“文本结构化 -> SVG/PNG 渲染 -> PPT 封装”流程，不走 SAM/MinerU 的复杂拆图重建，重点在“技术路线语义表达”。

注意一点：当前脚本里 req = Paper2FigureRequest() 默认 input_type="PDF"，见 [state.py (line 265)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，所以你在 [run_paper2technical.py (line 42)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 传的 paper_idea 通常会被 PDF 分支重新抽取覆盖；如果你想纯文本直出，应显式设 req.input_type="TEXT"。

------

**3) [run_paper2expfigure.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)（paper2expfigure）**
脚本入口见 [run_paper2expfigure.py (line 135)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，对应图在 [wf_paper2expfigure.py (line 51)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
执行链路是线性的：

1. pdf_to_images_node：PDF 每页转图片，见 [wf_paper2expfigure.py (line 108)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
2. mineru_extract_node：每页调用 MinerU 提取版面元素，见 [wf_paper2expfigure.py (line 146)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. table_extractor_node：从识别结果抽表格结构，并裁出表格图片，见 [wf_paper2expfigure.py (line 209)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. paper_idea_extractor：抽论文核心思想，供图表生成决策，见 [wf_paper2expfigure.py (line 302)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
5. chart_type_recommender_node：按表格内容推荐图表类型（并行），见 [wf_paper2expfigure.py (line 325)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
6. code_executor_node：生成 matplotlib 代码并执行，产出图表 PNG（并行），见 [wf_paper2expfigure.py (line 407)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
7. post_stylize_node：对图表做风格化重绘，见 [wf_paper2expfigure.py (line 613)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
8. assemble_to_ppt：把原始图和风格化图汇总进 PPT，见 [wf_paper2expfigure.py (line 665)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

> 而是从论文里抽表格并生成可复现的图表（再汇总到 PPT）

核心原理：
这是“表格驱动”的自动制图流水线：先 OCR/版面解析拿到表格，再让 LLM 选图类型+写代码，最后真实执行代码得到科研图，而不是直接文生图“猜”统计图。

补充：[run_paper2expfigure.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 里 output_dir 变量目前没写回 state.result_path（只计算了变量），见 [run_paper2expfigure.py (line 95)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。实际输出目录主要由 workflow 内部 pdf_to_images_node 决定。

## MetaGPT

这个项目可以按一条主链看：

1. 入口启动
   [setup.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 把 metagpt 命令映射到 metagpt.software_company:app（[setup.py (line 116)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
   CLI 入口在 [software_company.py (line 77)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，核心函数是 generate_repo（[software_company.py (line 14)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
2. 初始化上下文和团队
   generate_repo 会更新配置、创建 Context，然后组建 Team 并雇佣 5 个角色：TeamLeader、ProductManager、Architect、Engineer2、DataAnalyst（[software_company.py (line 40)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[software_company.py (line 45)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
3. 运行主循环
   [Team.run](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 先发布用户 idea，再按回合循环执行：直到回合耗尽、所有角色 idle、或预算用完（[team.py (line 123)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
   每回合调用 env.run() 并发跑各角色（[team.py (line 134)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
4. 消息路由机制
   默认用 MGXEnv（[team.py (line 43)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[team.py (line 51)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
   普通消息会先交给 TeamLeader，再由 TeamLeader分发给具体角色（[mgx_env.py (line 24)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[mgx_env.py (line 56)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[team_leader.py (line 75)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
5. 角色执行机制（Observe -> Think -> Act）
   通用角色循环在 [Role.run](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)：先观察消息，再思考，再执行并发布结果（[role.py (line 530)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
   当前这套角色大多基于 RoleZero：先做规划/工具选择，再把 LLM 输出解析成命令并调用工具（[role_zero.py (line 198)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[role_zero.py (line 284)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[role_zero.py (line 385)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
6. 产物落地
   典型流程会把需求和文档落到工作区（如 [requirement.txt](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、docs/prd、docs/system_design、resources/*），相关动作在 PrepareDocuments / WritePRD / WriteDesign（[prepare_documents.py (line 53)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[write_prd.py (line 75)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[design_api.py (line 146)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
   默认工作目录根是 workspace（[const.py (line 41)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。

## ModelingAgent

1. **批量任务调度**
2. **题目理解与建模方案生成（Selection）**
3. **每个子任务的模型细化（Modeling）**
4. **按变量自动采数（DataAgent）**
5. **基于数据做仿真与迭代打分（SimulationAgent）**
6. **把过程产物汇总成最终论文式解答（Writing）**
7. **可选：用 Judger 做多维度自动评审**

关键入口在 [mathmodel.py (line 33)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 和 [mathmodel.py (line 176)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

**按代码执行顺序讲原理**

1. main() 读配置和题库，多进程并发每道题（ProcessPoolExecutor）
   见 [mathmodel.py (line 176)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[mathmodel.py (line 197)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
2. 每道题进入 BaseAgent.run()，按固定流水线串联：
   Selection -> Modeling -> Data -> Simulation -> Writing
   见 [mathmodel.py (line 69)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 到 [mathmodel.py (line 107)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. **Selection 阶段**：先抽取建模问题，再生成假设，再做“生成-批评-再生成”循环，最后按评分排序建模方案。
   见 [selection.py (line 21)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[selection.py (line 48)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[selection.py (line 110)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. **Modeling 阶段**：对每个子任务执行多轮“建模实现-critic反馈-改写”，再抽取变量因子（data points）并做因子批评。
   见 [modeling.py (line 21)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[modeling.py (line 80)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[modeling.py (line 100)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
5. **DataAgent 阶段**：从 factors_* 中提取需要采集的变量，逐个变量进入工具调用循环。
   - LLM 必须输出 multi_tools_executor 工具调用
   - 调用 ToolHandler 执行文件、搜索、下载、OCR、代码执行等工具
   - 工具返回 finish=true 后触发打分，不达阈值继续迭代
     见 [data.py (line 1854)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[data.py (line 596)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[data.py (line 798)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[data.py (line 1076)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
     工具协议定义在 [function_call_prompts.py (line 1)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，工具执行在 [tool_handler.py (line 135)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
6. **SimulationAgent 阶段**：按子任务分组创建独立仿真目录（modeling_x_x），复制数据后进入“LLM工具调用->执行代码/读写文件->中期critic->继续迭代”循环；最后做最终critic评分决定成功与否。
   见 [simulation.py (line 712)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[simulation.py (line 913)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[simulation.py (line 1551)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[simulation.py (line 1905)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
7. **Writing 阶段**：读取建模历史、数据文件、仿真报告，分别写 data/simulation 章节，再合成最终 solution。
   见 [writing.py (line 77)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[writing.py (line 175)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[writing.py (line 249)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

**项目的“核心机制”**

1. **共享状态驱动**：所有阶段通过 SharedContext 的 [context.json](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 串联（类似黑板架构）。
   见 [shared_context.py (line 32)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
2. **生成-批评-再生成闭环**：Selection、Modeling、Data、Simulation 都有 critic 反馈环路，不是一次性生成。
   典型见 [modeling.py (line 37)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 与 [simulation.py (line 1551)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. **工具优先执行**：Data/Simulation 强制模型走 function-call，不允许只说不做。
   见 [data_acquire.py (line 1)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 和 [core.py (line 80)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. **目录隔离 + 可恢复**：每题独立 log/workspace，每组仿真独立目录，失败可重试，已有结果可跳过。
   见 [mathmodel.py (line 132)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[simulation.py (line 751)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[simulation.py (line 1934)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

如果你愿意，我可以下一步给你画一张“从单题输入到最终 writing_combined 输出”的简化时序图（按你当前配置参数展开）。

Paper2Slides

**整体流程（端到端）**

1. 输入层
   - CLI 入口：[main.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
   - Web 入口：[server.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) + [ChatWindow.jsx](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
2. 编排层
   - 核心调度：[pipeline.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
   - 阶段顺序固定：rag -> summary -> plan -> generate（定义在 [state.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
3. 输出层
   - 产物落盘到 outputs/<project>/<content>/<mode>/<config>/<timestamp>/...
   - 包含 checkpoint、图片、最终 PDF（slides 时）

**四个阶段的原理**

1. RAG 阶段（[rag_stage.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - fast 模式：只解析文档为 markdown + 图片，不建索引；直接用多模态 LLM 回答预设问题。
   - normal 模式：走 RAGAnything/LightRAG 建索引，再按类别批量检索问答。
   - 结果保存 [checkpoint_rag.json](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)（含 rag_results、markdown_paths）。
2. Summary 阶段（[summary_stage.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - 把 RAG 问答按论文结构聚合（motivation/solution/results/contributions 等）。
   - paper 内容会再做结构化抽取；general 更偏原样整合。
   - 同时从 markdown 抽取原始表格/图片并保留引用关系。
   - 输出 [summary.md](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 和 [checkpoint_summary.json](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. Plan 阶段（[plan_stage.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - 用 ContentPlanner（[content_planner.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）把摘要变成“页面蓝图”：每页标题、正文、引用哪些图表。
   - 会把图像（base64）+ 表格一起喂给多模态模型，返回结构化 JSON。
   - 输出 [checkpoint_plan.json](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. Generate 阶段（[generate_stage.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - ImageGenerator（[image_generator.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）按 plan 逐页生成图。
   - Slides：前 2 页串行生成，第 2 页作为风格参考，后续可并行（--parallel）。
   - 生成图片后可合并 [slides.pdf](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

**为什么它能“断点续跑”**

- 检查点机制在 [state.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) + [paths.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
- 自动检测从哪一步继续：[detect_start_stage(...)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
- [state.json](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 记录每阶段 pending/running/completed/failed。
- 所以换风格通常只需从 plan 或 generate 重跑，不必重新解析论文。

**Web 端实际交互链路**

1. 前端发 /api/chat 上传文件或复用 session_id。
2. 后端立即返回 session_id，后台异步跑流水线。
3. 前端每 1.5s 轮询 /api/status/{session_id} 更新进度卡。
4. 完成后调 /api/result/{session_id} 拉取图片/PDF 链接。
5. 支持 /api/cancel/{session_id} 取消任务（SessionManager 控制并发和取消）。

## PPTAgent

这个项目本质上是一个“多 Agent + 工具调用（MCP）”的自动做 PPT 系统，核心有两条生成链路：

- freeform（DeepPresenter）：先做研究文稿，再做 HTML 视觉页，再转成 PPT/PDF
- template（PPTAgent）：先选模板布局，再按结构化元素逐页生成 PPTX

关键入口和流程如下。

1. WebUI 收请求
   [webui.py (line 166)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 的 send_message 收到指令/附件后，调用 AgentLoop.run()（[webui.py (line 204)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
2. 建会话工作区 + 初始化环境
   [main.py (line 41)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 的 [AgentLoop.run](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 会：
   - 保存输入请求到工作区
   - 启动 AgentEnv（[env.py (line 35)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - 按 [mcp.json](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 连接多个 MCP server 并拉取可用工具（[env.py (line 163)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，[mcp.json.example](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
3. 先跑 Research Agent，产出 Markdown 文稿
   [Research.loop](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 是“LLM 发 tool call -> 执行工具 -> 继续循环”直到 finalize（[research.py (line 7)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
   底层循环在 Agent.action/execute（[agent.py (line 169)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [(line 220)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
   常用工具包括：
   - 文件转 markdown：[any2markdown.py (line 30)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
   - 抓网页/下载资源：[fetch.py (line 22)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [(line 80)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
   - 学术检索：[research.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
   - 文稿检查：[richfile.py (line 60)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
   - finalize 做结果校验：[task.py (line 166)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
4. 分叉：模板模式 or 自由设计模式
   在 [main.py (line 100)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 按 convert_type 分支：
   - 模板模式（PPTAgent）
     调 [PPTAgent.loop](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)（[pptagent.py (line 6)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)），通过 pptagent MCP 工具逐页生成：
     - set_template/create_slide/write_slide/generate_slide/save_generated_slides（[mcp_server.py (line 160)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [(line 186)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [(line 214)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [(line 256)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [(line 288)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - 自由设计模式（Design）
     调 [Design.loop](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)（[design.py (line 6)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)），输出 HTML slides 目录；每页可用 inspect_slide 做视觉检查（[richfile.py (line 22)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）。
     然后转产物：
     - 先尝试 HTML->PPTX（[main.py (line 159)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [webview.py (line 124)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
     - 同时用 Playwright 导出 PDF（[main.py (line 173)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#), [webview.py (line 43)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
5. 收尾与可追溯
   流程结束会写中间产物和历史记录：

- [intermediate_output.json](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)（[main.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
- 各 Agent history（[agent.py (line 319)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
- 工具调用历史（[env.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）



## Paper2Any

先给你一个总框架：这三个脚本本质都是
构造 Paper2FigureState -> run_workflow("注册名", state) -> LangGraph 按节点图执行，见 [__init__.py (line 32)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
工作流名通过 [register(...)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 绑定，见 [registry.py (line 32)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

**1) [run_paper2figure.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)（paper2fig_with_sam）**
实际入口见 [run_paper2figure.py (line 28)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[run_paper2figure.py (line 50)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)，对应图在 [wf_paper2figure_with_sam.py (line 94)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
执行链路（PDF 模式）是：

1. _start_ 初始化输出目录 outputs/paper2figure/<ts>，见 [wf_paper2figure_with_sam.py (line 900)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
2. paper_idea_extractor 从 PDF 抽论文核心思路，见 [wf_paper2figure_with_sam.py (line 149)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. figure_desc_generator 把论文思路转成“绘图描述”，见 [wf_paper2figure_with_sam.py (line 157)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. figure_generator 先生成“完整图”，再二次编辑生成“空框模板图”，见 [wf_paper2figure_with_sam.py (line 167)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
5. figure_layout_sam 对模板图做 SAM 分割，再 PNG->SVG->EMF 得到背景框架层，见 [wf_paper2figure_with_sam.py (line 230)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)、[wf_paper2figure_with_sam.py (line 316)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
6. figure_mask_generator 对完整图做 MinerU 递归解析，提取文本块和图像块（内容层），见 [wf_paper2figure_with_sam.py (line 365)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
7. figure_icon_bg_remover 给图像元素抠背景，见 [wf_paper2figure_with_sam.py (line 648)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
8. figure_ppt_generator 合成 PPT：背景框架层(EMF) + 内容层(text/image)，见 [wf_paper2figure_with_sam.py (line 689)](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

核心原理：
“布局层”和“内容层”分离。布局靠 SAM+矢量化（更可编辑），内容靠 MinerU 解析和元素重建，最后在同一坐标系叠合成可编辑 PPT。

## Edit-Banana

**整体主流程（当前仓库实现）**

1. 输入图片后先做预处理（可选超分），建立共享上下文 ProcessingContext。入口在 [main.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
2. 先跑文字链路：OCR 识别文本/公式，生成一份“文字专用 drawio XML”并暂存。核心在 [restorer.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
3. 再跑图形链路：SAM3 按提示词组分批提取元素（背景、基本图形、图片类、箭头），并做组内/组间去重。核心在 [sam3_info_extractor.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。
4. 对不同元素分别处理并生成各自 XML 片段：
   - 图片/icon：抠图或转 base64 图片单元格（[icon_picture_processor.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - 基本图形：取填充色/描边色/线宽，转矢量样式（[basic_shape_processor.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - 箭头：尽量骨架化为矢量路径，失败则回退为图片（[arrow_processor.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
5. 可选质量评估与补救：
   - 评估覆盖率，找漏检区域（[metric_evaluator.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
   - 对漏检区域直接裁剪成 picture 元素补进去（[refinement_processor.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)）
6. 最后统一合并：
   - 收集所有 XML 片段（图形+文字）
   - 按层级排序（背景→图形→图片→箭头→文字）
   - 重新分配 mxCell id，输出最终 [.drawio.xml](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)
     核心在 [xml_merger.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#)。

**这个设计的关键原理**

- **职责拆分**：每类元素单独处理，降低互相干扰。
- **分层合成**：通过 layer_level 控制 DrawIO 的前后遮挡关系。
- **保底策略**：不能矢量化就回退成图片，优先保证“视觉不丢失”。
- **坐标一致性**：若前面做过超分，合并时会把坐标缩回原图尺度，保证文本与图形对齐。

**入口形态**

- CLI：python main.py -i ...
- API：[server_pa.py](https://file+.vscode-resource.vscode-cdn.net/Users/oujiazhan/.vscode/extensions/openai.chatgpt-0.4.71-darwin-x64/webview/#) 的 /convert 本质也是调用同一条 Pipeline。

Paperbanana

代码数据集待开源